name: Build-Scan-Push-Deploy (Self-Hosted Runner)

on:
  push:
    branches: [ main ]

jobs:
  pipeline:
    runs-on: self-hosted   # <<< local runner on your VM

    steps:
    # ------------------
    # CHECKOUT CODE
    # ------------------
    - uses: actions/checkout@v4

    # ------------------
    # BUILD IMAGE
    # ------------------
    - name: Build Docker image
      run: |
        docker build \
          -t ghcr.io/${{ github.repository_owner }}/devsecops-app:latest \
          -f app/Dockerfile \
          app/

    # ------------------
    # SCAN IMAGE WITH TRIVY
    # ------------------
    - name: Scan image with Trivy
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: ghcr.io/${{ github.repository_owner }}/devsecops-app:latest
        severity: CRITICAL,HIGH
        ignore-unfixed: true
        exit-code: '0'   # allow workshop to continue

    # ------------------
    # PUSH IMAGE TO GHCR
    # ------------------
    - name: Login to GHCR
      run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Push image
      run: docker push ghcr.io/${{ github.repository_owner }}/devsecops-app:latest

    # ------------------
    # INSTALL KUBECTL
    # ------------------
    - name: Install kubectl
      uses: azure/setup-kubectl@v3

    # ------------------
    # DEPLOY TO LOCAL MINIKUBE
    # ------------------
    - name: Deploy to Minikube
      run: kubectl apply -f k8s/

    # ------------------
    # WAIT FOR ROLLOUT SUCCESS
    # ------------------
    - name: Wait for rollout
      run: kubectl rollout status deployment/devsecops-app
