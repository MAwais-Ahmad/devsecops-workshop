name: Build-Scan-Push-Deploy (Cloud Runner)

on:
  push:
    branches: [ main ]

jobs:
  pipeline:
    runs-on: ubuntu-latest

    steps:
    # ------------------
    # CHECKOUT CODE
    # ------------------
    - uses: actions/checkout@v4

    # ------------------
    # BUILD IMAGE
    # ------------------
    - name: Build Docker image
      run: |
        docker build \
          -t ghcr.io/${{ github.repository_owner }}/devsecops-app:latest \
          -f app/Dockerfile \
          app/

    # ------------------
    # SCAN IMAGE WITH TRIVY
    # ------------------
    - name: Scan image with Trivy
      uses: aquasecurity/trivy-action@0.19.0
      with:
        image-ref: ghcr.io/${{ github.repository_owner }}/devsecops-app:latest
        severity: CRITICAL,HIGH
        ignore-unfixed: true
        exit-code: '0'   # do not fail the workshop

    # ------------------
    # PUSH TO GHCR
    # ------------------
    - name: Login to GHCR
      run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Push image
      run: docker push ghcr.io/${{ github.repository_owner }}/devsecops-app:latest

    # ------------------
    # INSTALL KUBECTL
    # ------------------
    - name: Install kubectl
      uses: azure/setup-kubectl@v3

    # ------------------
    # LOAD NGROK-EXPOSED KUBECONFIG
    # ------------------
    - name: Load kubeconfig (ngrok)
      run: |
        echo "${{ secrets.KUBECONFIG_NGROK }}" | base64 --decode > kubeconfig
        export KUBECONFIG=$PWD/kubeconfig

    # ------------------
    # TEST KUBECONFIG CONNECTIVITY
    # ------------------
    - name: Validate Kubernetes cluster connection
      run: |
        export KUBECONFIG=$PWD/kubeconfig
        echo "Testing API server connectivity..."
        kubectl version --short
        kubectl get nodes

    # ------------------
    # DEPLOY TO MINIKUBE (VIA NGROK TUNNEL)
    # ------------------
    - name: Deploy to Minikube
      run: |
        export KUBECONFIG=$PWD/kubeconfig
        kubectl apply -f k8s/

    # ------------------
    # WAIT FOR ROLLOUT SUCCESS
    # ------------------
    - name: Wait for rollout
      run: |
        export KUBECONFIG=$PWD/kubeconfig
        kubectl rollout status deployment/devsecops-app
